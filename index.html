<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Daily Grind & Dough Co. — Digital Menu</title>
  <!-- Load Lucide Icons first -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .btn-disabled { opacity: .6; pointer-events: none; }
    .error-text { font-size: 12px; color: #dc2626; margin-top: 4px; display:none; }
    .has-error { outline: none; box-shadow: 0 0 0 2px #fecaca; border-color:#ef4444 !important; }
  </style>

  <script>
    /* -------------------------- Branding image helpers -------------------------- */
    const RAW_LOGO   = "https://raw.githubusercontent.com/vsaipavan6/cafe/main/logo.png";
    const RAW_WIFIQR = "https://raw.githubusercontent.com/vsaipavan6/cafe/main/wifi.jpg";

    const toRaw = (url) => {
      try {
        if (!url) return "";
        if (/raw\.githubusercontent\.com|^\.?\/|^https?:\/\/[^/]+\.github\.io/.test(url)) return url;
        if (/https?:\/\/github\.com\/.+\/blob\//.test(url)) {
          return url.replace("https://github.com/", "https://raw.githubusercontent.com/").replace("/blob/", "/");
        }
        return url;
      } catch { return url; }
    };

    const LOGO_URL    = toRaw(RAW_LOGO)   || "logo.png";
    const FAVICON_URL = LOGO_URL;
    const WIFI_QR_URL = toRaw(RAW_WIFIQR) || "wifi.jpg";

    /* ---------------------------- Supabase settings ---------------------------- */
    const SUPABASE_URL  = "https://ihanajfastlgsqrrbmef.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImloYW5hamZhc3RsZ3NxcnJibWVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5OTg5MDMsImV4cCI6MjA3NzU3NDkwM30.FKcKzjeVf7bO6zDwPjRG70cLI0ca7C9PFhzjwOQUs0A";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  </script>

  <link id="dynamic-favicon" rel="icon" type="image/png" href="" />
  <link rel="icon" href="favicon.png" type="image/png" />
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-50 min-h-screen">
  <!-- Header -->
  <header class="bg-gradient-to-r from-amber-700 to-orange-600 text-white p-4 sm:p-6 shadow-lg sticky top-0 z-20">
    <div class="max-w-5xl mx-auto flex justify-between items-center gap-3">
      <div class="flex items-center gap-3">
        <img id="logoImg" src="" alt="Cafe Logo" class="w-12 h-12 rounded-full ring-2 ring-white/80 shadow-md object-cover" />
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold leading-tight">The Daily Grind & Dough Co.</h1>
          <p class="text-xs sm:text-sm text-amber-100">Scan • Order • Enjoy</p>
        </div>
      </div>

      <div class="flex items-center gap-2 sm:gap-4">
        <div class="hidden sm:flex items-center bg-white/95 text-gray-700 rounded-full px-3 py-2 shadow-inner">
          <i data-lucide="search" class="w-4 h-4 mr-2"></i>
          <input id="searchInput" type="text" placeholder="Search menu…" class="bg-transparent outline-none placeholder:text-gray-400 w-40" />
        </div>

        <button onclick="toggleCart()" class="relative bg-white text-amber-700 p-3 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition" aria-label="Open cart" type="button">
          <span id="headerBasket" class="inline-block w-6 h-6"></span>
          <span id="cartBadge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center font-bold"></span>
        </button>
      </div>
    </div>

    <div class="max-w-5xl mx-auto mt-4 overflow-x-auto">
      <div id="categoryTabs" class="flex gap-2"></div>
    </div>
  </header>

  <!-- Promo / Hero -->
  <section class="max-w-5xl mx-auto p-4 sm:p-6">
    <div class="bg-white rounded-2xl shadow-md p-5 sm:p-8 flex flex-col sm:flex-row items-center gap-6">
      <img id="heroLogo" src="" class="w-28 h-28 rounded-full ring-4 ring-amber-100 shadow object-cover" alt="Cafe Logo"/>
      <div class="flex-1">
        <h2 class="text-2xl sm:text-3xl font-bold text-amber-800 mb-2">Welcome to The Daily Grind & Dough Co.</h2>
        <p class="text-gray-600">Authentic Italian-inspired coffee, fresh bakes, and quick bites. Tap to add, customize quantities, and pay at the counter or via UPI/QR.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <button id="wifiChip" class="px-3 py-1 rounded-full bg-amber-100 text-amber-800 hover:bg-amber-200 transition cursor-pointer" type="button">Free Wi-Fi</button>
          <span class="px-3 py-1 rounded-full bg-amber-100 text-amber-800">Freshly Baked Daily</span>
          <span class="px-3 py-1 rounded-full bg-amber-100 text-amber-800">Vegetarian Options</span>
          <span class="px-3 py-1 rounded-full bg-amber-100 text-amber-800">Takeaway Available</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Menu Container -->
  <main id="menuContainer" class="max-w-5xl mx-auto p-4 sm:p-6 pb-32"></main>

  <!-- Cart Sidebar -->
  <div id="cartOverlay" class="hidden fixed inset-0 bg-black/50 z-30" onclick="closeCart()">
    <aside class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl overflow-y-auto" onclick="event.stopPropagation()">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center gap-3">
            <span id="panelBasket" class="inline-block w-6 h-6"></span>
            <h2 class="text-2xl font-bold text-gray-800 leading-tight">Your Order</h2>
          </div>
          <button onclick="closeCart()" class="text-gray-500 hover:text-gray-700" aria-label="Close cart" type="button">
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>

        <div id="cartItems" class="space-y-4 mb-6"></div>

        <div id="cartTotal" class="hidden border-t pt-4 mb-6 space-y-3">
          <div class="flex justify-between items-center text-lg font-semibold">
            <span>Subtotal</span>
            <span class="text-amber-700">₹<span id="subtotalAmount">0</span></span>
          </div>
          <div class="flex justify-between items-center text-sm text-gray-600">
            <span>Service Charge (5%)</span>
            <span>₹<span id="svcAmount">0</span></span>
          </div>
          <div class="flex justify-between items-center text-sm text-gray-600">
            <span>Tax (GST 5%)</span>
            <span>₹<span id="taxAmount">0</span></span>
          </div>
          <div class="flex justify-between items-center text-xl font-extrabold">
            <span>Total</span>
            <span class="text-amber-600">₹<span id="totalAmount">0</span></span>
          </div>
        </div>

        <!-- Autofill-resistant customer form -->
        <div id="customerForm" class="hidden space-y-3 mb-6" autocomplete="off">
          <div class="grid grid-cols-2 gap-3">
            <div class="col-span-2">
              <input
                type="text"
                id="customerName"
                placeholder="Your Name"
                inputmode="text"
                pattern="[A-Za-z .'-]{2,40}"
                maxlength="40"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="words"
                spellcheck="false"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                title="Only letters, spaces, . ' - (2–40 characters)"
              >
              <div id="errName" class="error-text">Name must be letters/spaces only (2–40 chars).</div>
            </div>

            <div class="col-span-2">
              <input
                type="text"
                id="tableNumber"
                placeholder="Table Number (1–999)"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="3"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="none"
                spellcheck="false"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                title="Enter an integer between 1 and 999"
              >
              <div id="errTable" class="error-text">Table number must be an integer (1–999).</div>
            </div>

            <div class="col-span-2">
              <textarea
                id="orderNotes"
                rows="2"
                placeholder="Add a note (letters/punctuation, max 200 chars)"
                inputmode="text"
                maxlength="200"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="sentences"
                spellcheck="false"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                title="Notes must be text (not numbers only), up to 200 characters"
              ></textarea>
              <div id="errNotes" class="error-text">Notes must be text (not only digits), up to 200 characters.</div>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-between mb-4">
          <button id="clearCartBtn" class="hidden text-sm text-red-600 hover:underline" onclick="clearCart()" type="button">Clear cart</button>
          <div class="text-xs sm:text-sm text-gray-500">
            <span class="mr-2">Choose payment option:</span>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="payCounterBtn" type="button" class="hidden w-full bg-white text-amber-700 border border-amber-600 py-3 rounded-xl font-bold hover:bg-amber-50 transition shadow-sm">
            Pay at Counter
          </button>
          <button id="paymentBtn" type="button" class="hidden w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white py-3 rounded-xl font-bold hover:from-amber-700 hover:to-orange-700 transition shadow-lg">
            Pay Online
          </button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Wi-Fi QR Modal -->
  <div id="wifiModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50" onclick="closeWifiModal()">
    <div class="bg-white rounded-2xl p-4 sm:p-6 max-w-xs sm:max-w-md w-[90%] shadow-2xl" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold text-gray-800">Free Wi-Fi</h3>
        <button onclick="closeWifiModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close Wi-Fi modal" type="button">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <img id="wifiImg" src="" alt="Wi-Fi QR Code" class="w-full rounded-lg border border-gray-200"/>
      <p class="text-xs text-gray-500 mt-2">Scan this QR to connect to Wi-Fi.</p>
    </div>
  </div>

  <!-- Order Success Modal -->
  <div id="successModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-40" onclick="closeSuccessModal()">
    <div class="bg-white rounded-2xl p-8 max-w-sm mx-4 text-center relative" onclick="event.stopPropagation()">
      <button onclick="closeSuccessModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600" aria-label="Close" type="button">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i data-lucide="check" class="w-8 h-8 text-green-600"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">Order Placed!</h3>
      <p class="text-gray-600 mb-4">Thank you. Your order will be ready soon.</p>
      <div id="orderDetails" class="text-left bg-gray-50 rounded-lg p-4 text-sm">
        <div class="flex justify-between mb-2">
          <span class="text-gray-600">Order ID:</span>
          <span class="font-bold" id="modalOrderId">-</span>
        </div>
        <div class="flex justify-between mb-2">
          <span class="text-gray-600">Table:</span>
          <span class="font-semibold" id="modalTable">-</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Total:</span>
          <span class="font-bold text-amber-600" id="modalTotal">₹0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Cart Button -->
  <button onclick="toggleCart()" class="fixed bottom-6 right-6 bg-gradient-to-r from-amber-600 to-orange-600 text-white p-5 rounded-full shadow-2xl hover:scale-110 transition z-30" aria-label="Open cart" type="button">
    <span id="fabBasket" class="inline-block w-7 h-7"></span>
    <span id="cartBadgeFloating" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center font-bold"></span>
  </button>

  <script>
    /* ------------------------------ Icons & UI ------------------------------ */
    const basketSVG = (size=24) => `
      <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M3 10h18l-1.2 9a3 3 0 0 1-3 2.6H7.2A3 3 0 0 1 4.2 19L3 10Z" fill="#F59E0B"/>
        <path d="M6 10c0-3 2.7-6 6-6s6 3 6 6" stroke="#92400E" stroke-width="2" stroke-linecap="round"/>
        <path d="M7 14h10M6 17h12" stroke="#B45309" stroke-width="2" stroke-linecap="round"/>
        <path d="M9.5 6c.6-.9 1.8-1.5 2.5-1.5M7.5 8C8.3 6.9 9.2 6.4 10 6.1" stroke="#FDE68A" stroke-width="2" stroke-linecap="round"/>
      </svg>`;

    const placeBaskets = () => {
      [["headerBasket",24],["panelBasket",24],["fabBasket",28]].forEach(([id,size]) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = basketSVG(size);
      });
    };

    function createLucideIcons() {
      try {
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
          lucide.createIcons();
        }
      } catch (error) {
        console.warn('Lucide icons not available:', error);
      }
    }

    /* ------------------------------- Menu Data ------------------------------ */
    const menuCategories = [
      { name: 'Coffee', items: [
          { id: 1, name: 'Espresso', price: 80, description: 'Classic Italian single shot' },
          { id: 2, name: 'Cappuccino', price: 130, description: 'Espresso with steamed milk foam' },
          { id: 3, name: 'Latte', price: 140, description: 'Smooth milk + espresso' },
          { id: 4, name: 'Americano', price: 100, description: 'Espresso with hot water' },
          { id: 5, name: 'Macchiato', price: 110, description: 'Espresso marked with foam' },
        ]},
      { name: 'Breads & Bakes', items: [
          { id: 6, name: 'Garlic Bread', price: 110, description: 'Buttery & garlicky' },
          { id: 7, name: 'Bruschetta', price: 120, description: 'Tomato & basil on toast' },
          { id: 8, name: 'Croissant (Butter)', price: 90, description: 'Flaky, fresh-baked' },
          { id: 9, name: 'Focaccia Slice', price: 130, description: 'Rosemary & olive oil' },
        ]},
      { name: 'Panini & Pizza', items: [
          { id: 10, name: 'Veggie Panini', price: 150, description: 'Grilled veggies, pesto' },
          { id: 11, name: 'Cheese Panini', price: 150, description: 'Melted cheese delight' },
          { id: 12, name: 'Margherita Pizza (slice)', price: 160, description: 'Tomato, mozzarella, basil' },
        ]},
      { name: 'Desserts', items: [
          { id: 13, name: 'Tiramisu (cup)', price: 180, description: 'Coffee-soaked, mascarpone' },
          { id: 14, name: 'Panna Cotta', price: 160, description: 'Creamy Italian pudding' },
          { id: 15, name: 'Gelato (scoop)', price: 100, description: 'Italian-style ice cream' },
        ]},
      { name: 'Drinks', items: [
          { id: 16, name: 'Sparkling Water', price: 60, description: 'Chilled & refreshing' },
          { id: 17, name: 'Iced Latte', price: 150, description: 'Cold, smooth espresso drink' },
          { id: 18, name: 'Orange Soda', price: 90, description: 'Citrusy fizz' },
        ]},
    ];

    /* ------------------------ Local cart (and helpers) ---------------------- */
    const CART_KEY = 'cafe_cart';
    let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
    function persistCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

    // Clear & defeat autofill
    function clearCustomerFields() {
      ['customerName','tableNumber','orderNotes'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = '';
        el.removeAttribute('value');
      });
    }
    function randomizeFieldNames() {
      const stamp = Date.now().toString(36);
      const map = {
        customerName: `customerName-${stamp}`,
        tableNumber:  `tableNumber-${stamp}`,
        orderNotes:   `orderNotes-${stamp}`
      };
      Object.entries(map).forEach(([id, newName]) => {
        const el = document.getElementById(id);
        if (el) el.setAttribute('name', newName);
      });
    }

    function clearCartHard() {
      cart = [];
      localStorage.removeItem(CART_KEY);
      clearCustomerFields();
      randomizeFieldNames();
      updateCartUI();
      renderMenu();
    }

    function getItemQty(itemId) {
      const it = cart.find(i => i.id === itemId);
      return it ? it.quantity : 0;
    }

    /* -------------------------- Category & rendering ------------------------ */
    let activeCategory = 'All';
    function renderCategoryTabs() {
      const tabs = ['All', ...menuCategories.map(c => c.name)];
      const wrap = document.getElementById('categoryTabs');
      wrap.innerHTML = tabs.map(name => `
        <button type="button" data-cat="${name}" class="px-4 py-2 rounded-full text-sm bg-white/90 text-amber-800 shadow hover:bg-white transition ${name===activeCategory ? 'ring-2 ring-amber-500 font-semibold' : ''}">${name}</button>
      `).join('');
      wrap.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => { activeCategory = btn.dataset.cat; renderCategoryTabs(); renderMenu(); }));
    }

    /* ---------------------- Homepage menu (UPDATED) ------------------------- */
    function renderMenu() {
      const container = document.getElementById('menuContainer');
      const q = (document.getElementById('searchInput')?.value || '').toLowerCase();

      const cats = activeCategory === 'All' ? menuCategories : menuCategories.filter(c => c.name === activeCategory);
      const html = cats.map(category => {
        const items = category.items.filter(i => i.name.toLowerCase().includes(q) || i.description.toLowerCase().includes(q));
        if (!items.length) return '';
        return `
        <section class="mb-8">
          <div class="flex items-center gap-2 mb-2">
            <h2 class="text-2xl font-bold text-amber-800">${category.name}</h2>
            <span class="h-1 w-16 bg-amber-500 rounded"></span>
          </div>
          <div class="grid sm:grid-cols-2 gap-4">
            ${items.map(item => {
              const qty = getItemQty(item.id);
              return `
              <article class="bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition">
                <div class="flex justify-between items-start gap-3">
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-800">${item.name}</h3>
                    <p class="text-sm text-gray-600 mt-1">${item.description}</p>
                    <p class="text-xl font-bold text-amber-600 mt-2">₹${item.price}</p>
                  </div>
                  ${
                    qty > 0
                      ? `
                        <div class="flex items-center gap-2 bg-amber-50 rounded-lg p-1 border border-amber-200">
                          <button type="button"
                                  class="w-8 h-8 flex items-center justify-center text-amber-700 hover:bg-amber-100 rounded font-bold transition-colors"
                                  aria-label="Decrease quantity"
                                  onclick="updateQuantity(${item.id}, -1)">
                            &minus;
                          </button>
                          <span class="font-semibold w-8 text-center text-amber-800">${qty}</span>
                          <button type="button"
                                  class="w-8 h-8 flex items-center justify-center text-amber-700 hover:bg-amber-100 rounded font-bold transition-colors"
                                  aria-label="Increase quantity"
                                  onclick="updateQuantity(${item.id}, 1)">
                            +
                          </button>
                        </div>
                      `
                      : `
                        <button type="button"
                                onclick="addToCart(${item.id})"
                                class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition flex items-center gap-2 shadow-sm">
                          <i data-lucide="plus" class="w-4 h-4"></i>
                          Add
                        </button>
                      `
                  }
                </div>
              </article>`;
            }).join('')}
          </div>
        </section>`;
      }).join('');

      container.innerHTML = html || '<p class="text-center text-gray-500">No matching items.</p>';
      createLucideIcons();
      placeBaskets();
    }

    /* ------------------------------ Cart logic ------------------------------ */
    function addToCart(itemId) {
      const item = menuCategories.flatMap(c => c.items).find(i => i.id === itemId);
      if (!item) return;
      const existing = cart.find(i => i.id === itemId);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ ...item, quantity: 1 });
      }
      persistCart();
      updateCartUI();
      renderMenu();
    }

    function updateQuantity(itemId, change) {
      const idx = cart.findIndex(i => i.id === itemId);
      if (idx === -1) return;

      cart[idx].quantity += change;

      if (cart[idx].quantity <= 0) {
        cart.splice(idx, 1);
      }

      persistCart();
      updateCartUI();
      renderMenu();
    }

    function removeFromCart(itemId) {
      cart = cart.filter(i => i.id !== itemId);
      persistCart();
      updateCartUI();
      renderMenu();
    }

    function clearCart(){
      cart = [];
      persistCart();
      updateCartUI();
      renderMenu();
    }

    function getSubtotal() {
      return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    }

    function updateCartUI() {
      const cartItems = document.getElementById('cartItems');
      const subtotalAmount = document.getElementById('subtotalAmount');
      const svcAmount = document.getElementById('svcAmount');
      const taxAmount = document.getElementById('taxAmount');
      const totalAmount = document.getElementById('totalAmount');
      const cartBadge = document.getElementById('cartBadge');
      const cartBadgeFloating = document.getElementById('cartBadgeFloating');
      const cartTotal = document.getElementById('cartTotal');
      const customerForm = document.getElementById('customerForm');
      const paymentBtn = document.getElementById('paymentBtn');
      const payCounterBtn = document.getElementById('payCounterBtn');
      const clearCartBtn = document.getElementById('clearCartBtn');

      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

      if (totalItems > 0) {
        cartBadge.classList.remove('hidden');
        cartBadge.textContent = totalItems;
        cartBadgeFloating.classList.remove('hidden');
        cartBadgeFloating.textContent = totalItems;
      } else {
        cartBadge.classList.add('hidden');
        cartBadgeFloating.classList.add('hidden');
      }

      if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">Your cart is empty</p>';
        cartTotal.classList.add('hidden');
        customerForm.classList.add('hidden');
        paymentBtn.classList.add('hidden');
        payCounterBtn.classList.add('hidden');
        clearCartBtn.classList.add('hidden');
      } else {
        cartItems.innerHTML = cart.map(item => `
          <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-semibold text-gray-800">${item.name}</h3>
              <button type="button" onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700" title="Remove item">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3 bg-white rounded-lg p-1 border border-gray-200">
                <button type="button" onclick="updateQuantity(${item.id}, -1)" class="w-8 h-8 flex items-center justify-center text-amber-700 bg-amber-50 hover:bg-amber-100 rounded font-bold transition-colors" title="Decrease quantity">&minus;</button>
                <span class="font-semibold w-8 text-center">${item.quantity}</span>
                <button type="button" onclick="updateQuantity(${item.id}, 1)" class="w-8 h-8 flex items-center justify-center text-amber-700 bg-amber-50 hover:bg-amber-100 rounded font-bold transition-colors" title="Increase quantity">+</button>
              </div>
              <span class="font-bold text-amber-600">₹${item.price * item.quantity}</span>
            </div>
          </div>
        `).join('');

        const subtotal = getSubtotal();
        const svc = Math.round(subtotal * 0.05);
        const tax = Math.round((subtotal + svc) * 0.05);
        const total = subtotal + svc + tax;
        subtotalAmount.textContent = subtotal;
        svcAmount.textContent = svc;
        taxAmount.textContent = tax;
        totalAmount.textContent = total;

        cartTotal.classList.remove('hidden');
        customerForm.classList.remove('hidden');
        paymentBtn.classList.remove('hidden');
        payCounterBtn.classList.remove('hidden');
        clearCartBtn.classList.remove('hidden');

        createLucideIcons();
      }

      placeBaskets();
    }

    /* ----------------------- Validation helpers (NEW) ----------------------- */
    const NAME_RE  = /^[A-Za-z][A-Za-z .'-]{1,39}$/;     // 2–40 chars, letters/spaces/.'-
    const TABLE_RE = /^(?:[1-9]\d{0,2})$/;               // 1–999
    const NOTES_RE = /^(?!\d+$).{0,200}$/;               // up to 200, not digits-only

    function showErr(el, errEl, msg){
      if (el){ el.classList.add('has-error'); }
      if (errEl){ errEl.textContent = msg; errEl.style.display='block'; }
    }
    function clearErr(el, errEl){
      if (el){ el.classList.remove('has-error'); }
      if (errEl){ errEl.style.display='none'; }
    }

    function liveFilters(){
      const nameEl  = document.getElementById('customerName');
      const tableEl = document.getElementById('tableNumber');
      const notesEl = document.getElementById('orderNotes');

      // Hard-filter typing:
      nameEl?.addEventListener('input', () => {
        // allow letters, space, period, apostrophe, hyphen; collapse spaces
        const cleaned = (nameEl.value || '').replace(/[^A-Za-z .'-]/g,'').replace(/\s{2,}/g,' ');
        if (cleaned !== nameEl.value) nameEl.value = cleaned;
      });

      tableEl?.addEventListener('input', () => {
        // numeric only, strip non-digits and clamp to 3 digits
        let cleaned = (tableEl.value || '').replace(/\D/g,'').slice(0,3);
        // trim leading zeros
        cleaned = cleaned.replace(/^0+/, '');
        tableEl.value = cleaned;
      });

      notesEl?.addEventListener('input', () => {
        // limit length and normalize whitespace
        let v = (notesEl.value || '').slice(0,200).replace(/\s{2,}/g,' ');
        notesEl.value = v;
      });

      // Clear errors on focus
      const map = [
        [nameEl,  document.getElementById('errName')],
        [tableEl, document.getElementById('errTable')],
        [notesEl, document.getElementById('errNotes')],
      ];
      map.forEach(([el, err]) => {
        el?.addEventListener('focus', ()=> clearErr(el, err));
      });
    }

    /* -------------------------- Cart overlay helpers ------------------------ */
    function toggleCart() {
      document.getElementById('cartOverlay').classList.toggle('hidden');
    }
    function closeCart() {
      document.getElementById('cartOverlay').classList.add('hidden');
    }

    /* ---------------------------- Wi-Fi modal UI ---------------------------- */
    function openWifiModal(){
      const img = document.getElementById('wifiImg');
      if (img && WIFI_QR_URL) img.src = WIFI_QR_URL;
      document.getElementById('wifiModal').classList.remove('hidden');
      createLucideIcons();
    }
    function closeWifiModal(){
      document.getElementById('wifiModal').classList.add('hidden');
    }

    /* ----------------------------- Order builder ---------------------------- */
    function createOrder(paymentMethod) {
      const nameEl   = document.getElementById('customerName');
      const tableEl  = document.getElementById('tableNumber');
      const notesEl  = document.getElementById('orderNotes');

      const errName  = document.getElementById('errName');
      const errTable = document.getElementById('errTable');
      const errNotes = document.getElementById('errNotes');

      const name  = (nameEl.value || '').trim();
      const table = (tableEl.value || '').trim();
      const notes = (notesEl.value || '').trim();

      // Clear prior errors
      clearErr(nameEl, errName);
      clearErr(tableEl, errTable);
      clearErr(notesEl, errNotes);

      // Validate
      let ok = true;
      if (!NAME_RE.test(name)) {
        showErr(nameEl, errName, "Name must be letters/spaces only (2–40 chars).");
        ok = false;
      }
      if (!TABLE_RE.test(table)) {
        showErr(tableEl, errTable, "Table number must be an integer from 1 to 999.");
        ok = false;
      }
      if (notes.length > 0 && !NOTES_RE.test(notes)) {
        showErr(notesEl, errNotes, "Notes must be text (not digits-only), up to 200 characters.");
        ok = false;
      }

      if (!ok) {
        alert("Please correct the highlighted fields:\n\n• Name: letters/spaces only (2–40)\n• Table: integer 1–999\n• Notes: text, not numbers-only (max 200)");
        return null;
      }

      const subtotal = getSubtotal();
      const svc = Math.round(subtotal * 0.05);
      const tax = Math.round((subtotal + svc) * 0.05);
      const total = subtotal + svc + tax;

      const order = {
        id: `ORD-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
        customerName: name,
        tableNumber: parseInt(table,10),
        notes,
        items: cart.map(item => ({...item})),
        totals: { subtotal, svc, tax, total },
        timestamp: new Date().toISOString(),
        status: 'new',
        payment: {
          method: paymentMethod,
          status: 'pending'
        }
      };
      return order;
    }

    /* ------------------------ Submit -> Supabase insert ---------------------- */
    let isSubmitting = false;

    function setPayButtonsDisabled(disabled) {
      const btns = [document.getElementById('payCounterBtn'), document.getElementById('paymentBtn')];
      btns.forEach(b => {
        if (!b) return;
        if (disabled) { b.classList.add('btn-disabled'); b.setAttribute('aria-disabled','true'); }
        else { b.classList.remove('btn-disabled'); b.removeAttribute('aria-disabled'); }
      });
    }

    // NO REDIRECT version
    async function submitOrder(order) {
      if (isSubmitting) return;
      isSubmitting = true;
      setPayButtonsDisabled(true);

      const { error } = await sb
        .from('orders')
        .insert({ id: order.id, payload: order, status: order.status });

      if (error) {
        console.error('[Cafe] Supabase insert failed:', error);
        alert('Failed to place order. Please try again.');
        isSubmitting = false;
        setPayButtonsDisabled(false);
        return;
      }

      // Clear cart + inputs to prevent duplicates and autofill ghosts
      clearCartHard();

      // Post-insert UI (no redirect)
      try {
        document.getElementById('modalOrderId').textContent = '#' + order.id.slice(-8);
        document.getElementById('modalTable').textContent   = order.tableNumber;
        document.getElementById('modalTotal').textContent   = '₹' + order.totals.total;
        document.getElementById('successModal').classList.remove('hidden');
        createLucideIcons();
        closeCart();
      } catch (uiErr) {
        console.warn('[Cafe] Order placed, UI update issue:', uiErr);
      } finally {
        isSubmitting = false;
        setPayButtonsDisabled(false);
      }
    }

    function closeSuccessModal() {
      document.getElementById('successModal').classList.add('hidden');
    }

    /* ------------------------------ Bind buttons ---------------------------- */
    document.addEventListener('DOMContentLoaded', () => {
      const bindPay = (id, method) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('click', async () => {
          if (isSubmitting) return;
          if (cart.length === 0) { alert('Cart is empty'); return; }
          const o = createOrder(method);
          if (o) await submitOrder(o); // no redirect path
        });
      };
      // BOTH buttons do NOT redirect
      bindPay('payCounterBtn', 'counter');
      bindPay('paymentBtn',    'online');
    });

    /* ------------------------------- Branding ------------------------------- */
    function initBranding(){
      const logo = document.getElementById('logoImg');
      const hero = document.getElementById('heroLogo');
      const fav  = document.getElementById('dynamic-favicon');
      const setSrc = (img, url, fallback) => {
        if (!img) return;
        img.src = url || fallback;
        img.onerror = () => { if (fallback && img.src !== fallback) img.src = fallback; };
      };
      setSrc(logo, LOGO_URL, "logo.png");
      setSrc(hero, LOGO_URL, "logo.png");
      if (fav) fav.href = FAVICON_URL || "favicon.png";
    }

    /* ----------------------------- Misc handlers ---------------------------- */
    window.addEventListener('error', (e) => {
      console.error('[Cafe] Uncaught error:', e.error || e.message);
    });

    window.addEventListener('unhandledrejection', (e)=> {
      console.warn('[Cafe] Unhandled promise rejection:', e.reason);
    });

    // When returning via back/restore, keep inputs/cart blank and names randomized
    window.addEventListener('pageshow', () => {
      clearCustomerFields();
      randomizeFieldNames();
    });

    document.getElementById('searchInput')?.addEventListener('input', () => renderMenu());

    document.addEventListener('keydown', (e)=>{ 
      if(e.key==='Escape'){ 
        closeWifiModal(); 
        closeCart(); 
        closeSuccessModal(); 
      } 
    });

    /* --------------------------------- Init -------------------------------- */
    document.addEventListener('DOMContentLoaded', () => {
      placeBaskets();
      document.getElementById('wifiChip')?.addEventListener('click', openWifiModal);
      initBranding();
      renderCategoryTabs();
      renderMenu();
      updateCartUI();
      // Ensure first open is clean & autofill-proof
      clearCustomerFields();
      randomizeFieldNames();
      createLucideIcons();
      placeBaskets();
      // NEW: start live input filters
      liveFilters();
    });
  </script>
</body>
</html>
